<!--
 * Polling Place Application
 * Copyright (c) 2013 Shama Hoque, Linda Avendano, Dan Gillette, Ted Selker
 * Licensed under Open Software License v. 3.0 (OSL-3.0)
 * Date: Wed, Dec 4 2013 
-->


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="EN" lang="EN" dir="ltr">
<head profile="http://gmpg.org/xfn/11">
  <title>Polling Place Application</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="styles/layout.css" type="text/css" />
  <link rel="stylesheet" href="styles/diagram_layout.css" type="text/css">
  <link rel="stylesheet" href="styles/jquery.ui.rotatable.css">
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
</head>
<body id="top">
  <div class="wrapper col1">
    <div id="topbar">
      <h1 class="mainTitle">Polling Place Application</h1>
    </div>
  </div>

  <div class="wrapper col2">

    <div id="homepage">
      <div id="head">
        <div class="instructions">
          <h3>Create your poll place layout<br> with simple drag and drop.</h3>
          <br/>

          <img src="images/overview.png"/>

        </div>
        <div class="outline_options">
          Select the basic outline of your voting area:
          <br/>
          <table border="0" style="padding:10px; margin: 0 auto;">
            <tr>
              <td><img src="images/Rec1.PNG" onclick="makeLayoutPage(1)"/></td>
              <td><img src="images/Rec2.PNG" onclick="makeLayoutPage(2)"/></td>
              <td><img src="images/Rec3.PNG" onclick="makeLayoutPage(3)"/></td>
            </tr>
            <tr>
              <td><img src="images/Rec4.PNG" onclick="makeLayoutPage(4)"/></td>
              <td><img src="images/Rec5.PNG" onclick="makeLayoutPage(5)"/></td>
              <td><img src="images/Rec6.PNG" onclick="makeLayoutPage(6)"/></td>
            </tr>
            <tr>
              <td><img src="images/Rec7.PNG" onclick="makeLayoutPage(7)"/></td>
              <td><img src="images/Rec8.PNG" onclick="makeLayoutPage(8)"/></td>
              <td><img src="images/Rec9.PNG" onclick="makeLayoutPage(9)"/></td>
            </tr>
          </table>

          <br class="clear" />
        </div>
      </div>
    </div>

    <div id="layout_edit" style="display:none; height: 700px;">
      <div class="col3">
        Polling Place Application
        <button onclick="location.reload();">Choose a different outline</button>
        <button onclick="saveCopy();">Save</button>
        <button onclick="reset();">Reset</button>
        
        <div id="checklistMenu">
          <span class='checklistButton'>Checklists</span>
      </div>
      <div id="workspaceMenu">
          <span class='workspaceButton'>Workspace</span>
      </div>
      </div>
      <div id="edit_body">
        <div id="edit">
          <div id="zoom-parent">
          <div id="zoom">
          <div id="diagram">
          </div>
          </div>
        </div>
          <div class="buttons">
            <button class="zoom-in">+</button><br/>
            <input type="range" class="zoom-range"><br/>
            <button class="zoom-out">-</button><br/>
            <!-- <button class="reset">Reset</button> -->
          </div>
        </div>

        <div id="toolbox">
        </div>
      </div>
    <div id="checklist_view" class="hide">
      <div id='tabNav'>



      </div>
      
        <div id="allToDos"></div>
    </div> 
      

      <div id="checkboxToDoList"></div>
      <div id="tabsToDoList"></div>

      <div id="default-tag-inputbox" style="display:none;">
        <div style="overflow:auto;">
            <div class="snapshot">
              
                <div style="text-align:center;">Photo Tag
                  <div id="screenshot-button" class="camera-button"></div> <button id="screenshot-stop-button" style="display:none;">Stop</button><br/>
                  <video id="screenshot-stream" class="videostream" autoplay></video>
                  <img id="screenshot" src="" style="display:none;">
                  <canvas id="screenshot-canvas" style="display:none;"></canvas>
                  
                </div>
            </div>
            <div class="notes">Notes:<br/>
                <textarea rows="18" cols="32" id="note">   
                </textarea>
            </div>
         </div> 
          <div class="flags">
            Flags:
          </div>
      </div>
    </div>


  </div>


<div class="wrapper col5">
  <div id="copyright">
    <p class="fl_left">Copyright &copy; 2013 - All Rights Reserved</p>
  </div>
</div>


<script type="text/javascript" src="js/jquery/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="js/jquery/jquery-ui.min.js"></script>
<script src="js/jquery/jquery.ui.touch-punch.min.js"></script>
<script src="js/jquery/jquery.ui.rotatable.js"></script>
<script src='js/jquery/jquery.simplemodal.1.4.4.min.js' type='text/javascript'></script>
<script src="js/jquery/jquery.panzoom.min.js"></script>
<script type="text/javascript" src="js/FileSaver.min.js"></script>
<script type="text/javascript" src="js/diagram.js"></script>

  <script>
    var tagData={};
    var snapped = false;
    var img = document.querySelector('#screenshot');
    var capturedImg = $('#screenshot')[0].src;
    tagData["total"] = 0;
    document.addEventListener("touchstart", function(){}, true);
        (function() {

          var $p = $('#zoom').panzoom({
            $zoomIn: $(".zoom-in"),
            $zoomOut: $(".zoom-out"),
            $zoomRange: $(".zoom-range"),
            $reset: $(".reset"),
            startTransform: 'scale(1.0)',
            increment: 0.1,
            minScale: 1,
            contain: 'invert'
          });

          $('#zoom-parent').on('click', function(e){
            e.preventDefault();
            $p.panzoom('zoom', {
              focal: e
            });
          });

        })();

        function errorCallback(e) {
          if (e.code == 1) {
            alert('User denied access to their camera');
          } else {
            alert('getUserMedia() not supported in your browser.');
          }
          //e.target.src = 'http://www.html5rocks.com/en/tutorials/video/basics/Chrome_ImF.ogv';
        }



        
        var video = document.querySelector('#screenshot-stream');
        var button = document.querySelector('#screenshot-button');
        var stopButton = document.querySelector('#screenshot-stop-button');
        var canvas = document.querySelector('#screenshot-canvas');
        
        var ctx = $('#screenshot-canvas')[0].getContext('2d');
        var localMediaStream = null;

        function sizeCanvas() {
          // video.onloadedmetadata not firing in Chrome so we have to hack.
          // See crbug.com/110938.
          setTimeout(function() {
            $('#screenshot-canvas')[0].width = $('#screenshot-stream')[0].videoWidth;
            $('#screenshot-canvas')[0].height = $('#screenshot-stream')[0].videoHeight;
            $('#screenshot')[0].height = $('#screenshot-stream')[0].videoHeight;
            $('#screenshot')[0].width = $('#screenshot-stream')[0].videoWidth;
          }, 100);
        }

        function snapshot() {
          $('#screenshot-canvas')[0].getContext('2d').drawImage( $('#screenshot-stream')[0], 0, 0);
          capturedImg = $('#screenshot-canvas')[0].toDataURL('image/webp');
          $('#screenshot')[0].src = capturedImg;
          console.log("Snap: " + capturedImg);
          $('#screenshot-stream').css('display', "none");
          $('#screenshot').css('display', "block");
          $('#screenshot-stream')[0].pause();
          localMediaStream.stop();
          localMediaStream = null;
          $('#screenshot-stop-button').css('display', "none");
          $('#screenshot-button').toggleClass("camera-button shot-button");
          snapped = true;

        }

        $('#screenshot-button').click(function(e){
          //$('#screenshot-button').toggleClass("camera-button shot-button");
          $('#screenshot')[0].src="";
          if(localMediaStream && localMediaStream != null) {
            
            snapshot();
            return;
          }
            

            $('#screenshot').css('display', "none");
            $('#screenshot-stream').css('display', "block");

          if (navigator.getUserMedia) {
            navigator.getUserMedia('video', function(stream) {
              $('#screenshot-stream')[0].src = stream;
              localMediaStream = stream;
              sizeCanvas();
              $('#screenshot-button').toggleClass("camera-button shot-button");
              $('#screenshot-stop-button').css('display', "inline-block");
            }, errorCallback);
          } else if (navigator.webkitGetUserMedia) {
            navigator.webkitGetUserMedia({video: true}, function(stream) {
              $('#screenshot-stream')[0].src = window.URL.createObjectURL(stream);
              localMediaStream = stream;
              sizeCanvas();
              $('#screenshot-button').toggleClass("camera-button shot-button");
              $('#screenshot-stop-button').css('display', "inline-block");
            }, errorCallback);
          } else {
            errorCallback({target: video});
          }
        });

        // $('#screenshot-stream')[0].addEventListener('click', snapshot, false);

        $('#screenshot-stop-button').click(function(e) {
          $('#screenshot-stream')[0].pause();
          if(localMediaStream!= null){
          localMediaStream.stop(); // Doesn't do anything in Chrome.
          localMediaStream = null;
        }
        });
        
        function saveTags($taggedItem){

           $('#screenshot-stream')[0].pause();
          if(localMediaStream!= null){
          localMediaStream.stop(); // Doesn't do anything in Chrome.
          localMediaStream = null;
        }
          var tagID = $taggedItem.attr('id');
          if(tagID){
            
          }else{
            tagData["total"]++;
            $taggedItem.attr('id', "taggedItem"+tagData["total"]);
            
          }
          console.log(tagData[$taggedItem.attr('id')]);
          if(!snapped){
            capturedImg = "";
            if(tagData[$taggedItem.attr('id')]){}
            else
            tagData[$taggedItem.attr('id')] = { "img":"", "notes":""};
          }

          tagData[$taggedItem.attr('id')]={"img":snapped ? capturedImg : tagData[$taggedItem.attr('id')].img, "notes":$("#note").val()};
          console.log("saved: " + capturedImg);
          $('#screenshot')[0].src="";
          $("#note").val("");
          console.log(tagData);
          snapped = false;
        }
      </script>
</body>
</html>
